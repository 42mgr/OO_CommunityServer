name: Build Custom OnlyOffice with Mail Module Changes

on:
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: 'Force rebuild even if cached'
        type: boolean
        default: false
      skip_docker:
        description: 'Skip Docker image build'
        type: boolean
        default: false

env:
  ONLYOFFICE_VERSION: "12.7.1"
  FORCE_REBUILD: ${{ github.event.inputs.force_rebuild || 'false' }}
  SKIP_DOCKER: ${{ github.event.inputs.skip_docker || 'false' }}
  FALLBACK_VERSIONS: "12.7.0,12.6.0,12.5.2,12.1.0,12.0.1"

jobs:
  prepare-environment:
    runs-on: ubuntu-latest
    outputs:
      cache-hit-deb: ${{ steps.cache-deb.outputs.cache-hit }}
      cache-hit-extracted: ${{ steps.cache-extracted.outputs.cache-hit }}
      skip-build: ${{ steps.check-changes.outputs.skip-build }}
      
    steps:
    - name: Checkout code (shallow)
      uses: actions/checkout@v4
      with:
        fetch-depth: 1
        submodules: false
        
    - name: Check for relevant changes
      id: check-changes
      run: |
        CHANGED_FILES=$(git diff --name-only HEAD~1 2>/dev/null || echo "all")
        
        if [[ "$CHANGED_FILES" == "all" ]] || echo "$CHANGED_FILES" | grep -E "(module/ASC\.Mail|\.github/workflows)" > /dev/null; then
          echo "skip-build=false" >> $GITHUB_OUTPUT
          echo "üìù Changes detected in mail module or workflow"
        else
          echo "skip-build=true" >> $GITHUB_OUTPUT  
          echo "‚ö° No mail module changes detected"
        fi
        
    - name: Multi-level cache for DEB package
      id: cache-deb
      uses: actions/cache@v4
      with:
        path: onlyoffice-communityserver.deb
        key: onlyoffice-deb-v2-${{ env.ONLYOFFICE_VERSION }}
        restore-keys: |
          onlyoffice-deb-v2-
          onlyoffice-deb-
        
    - name: Multi-level cache for extracted package  
      id: cache-extracted
      uses: actions/cache@v4
      with:
        path: official-package/
        key: onlyoffice-extracted-v2-${{ env.ONLYOFFICE_VERSION }}-${{ hashFiles('onlyoffice-communityserver.deb') }}
        restore-keys: |
          onlyoffice-extracted-v2-${{ env.ONLYOFFICE_VERSION }}-
          onlyoffice-extracted-v2-
          
    - name: Install dependencies (parallel)
      if: steps.cache-deb.outputs.cache-hit != 'true' || steps.cache-extracted.outputs.cache-hit != 'true'
      run: |
        sudo apt-get update -qq &
        wait
        sudo apt-get install -y --no-install-recommends wget curl dpkg-dev &
        wait
        
    - name: Check available OnlyOffice versions
      if: steps.cache-deb.outputs.cache-hit != 'true'
      run: |
        echo "üîç Checking available OnlyOffice versions..."
        
        echo "GitHub releases:"
        curl -s "https://api.github.com/repos/ONLYOFFICE/CommunityServer/releases" | \
          jq -r '.[].tag_name' | head -5 || echo "GitHub API check failed"
        
        echo "Checking download.onlyoffice.com..."
        curl -s -I "https://download.onlyoffice.com/install/community/" || echo "Download site check failed"
        
        echo "Proceeding with configured version: ${{ env.ONLYOFFICE_VERSION }}"
        
    - name: Smart download with repository method
      if: steps.cache-deb.outputs.cache-hit != 'true'
      run: |
        echo "‚¨áÔ∏è Setting up OnlyOffice repository and downloading package..."
        
        echo "üîß Adding OnlyOffice repository..."
        wget -qO - https://download.onlyoffice.com/GPG-KEY-ONLYOFFICE | sudo apt-key add -
        echo "deb https://download.onlyoffice.com/repo/debian squeeze main" | sudo tee /etc/apt/sources.list.d/onlyoffice.list
        
        sudo apt-get update -qq
        
        echo "üì¶ Downloading OnlyOffice Community Server package..."
        
        download_success=false
        
        echo "üì¶ Downloading OnlyOffice Community Server package..."
        if apt-get download onlyoffice-communityserver 2>/dev/null; then
          deb_file=$(find . -name "onlyoffice-communityserver*.deb" -type f | head -1)
          if [ -n "$deb_file" ] && [ -s "$deb_file" ]; then
            if [ "$deb_file" != "./onlyoffice-communityserver.deb" ]; then
              mv "$deb_file" onlyoffice-communityserver.deb
            fi
            echo "‚úÖ Downloaded via apt-get download"
            download_success=true
          fi
        fi
        
        if [ "$download_success" = false ]; then
          echo "üîÑ Trying alternative repositories..."
          echo "deb https://download.onlyoffice.com/repo/debian/community stable main" | sudo tee /etc/apt/sources.list.d/onlyoffice-community.list
          sudo apt-get update -qq
          
          if apt-get download onlyoffice-communityserver 2>/dev/null; then
            deb_file=$(find . -name "onlyoffice-communityserver*.deb" -type f | head -1)
            if [ -n "$deb_file" ] && [ -s "$deb_file" ]; then
              if [ "$deb_file" != "./onlyoffice-communityserver.deb" ]; then
                mv "$deb_file" onlyoffice-communityserver.deb
              fi
              echo "‚úÖ Downloaded from community repository"
              download_success=true
            fi
          fi
        fi
        
        if [ "$download_success" = false ]; then
          echo "‚ùå All download methods failed!"
          echo "üí° Please check if OnlyOffice ${{ env.ONLYOFFICE_VERSION }} is available"
          exit 1
        fi
        
        echo "üì¶ Final package info:"
        ls -lh onlyoffice-communityserver.deb
        dpkg-deb --info onlyoffice-communityserver.deb | head -10
        
    - name: Fast extraction (only if needed)
      if: steps.cache-extracted.outputs.cache-hit != 'true'
      run: |
        echo "üì¶ Extracting package..."
        
        mkdir -p official-package
        dpkg-deb -x onlyoffice-communityserver.deb official-package/ &
        dpkg-deb -e onlyoffice-communityserver.deb official-package/DEBIAN/ &
        wait
        
        extracted_files=$(find official-package -type f | wc -l)
        if [ "$extracted_files" -gt 100 ]; then
          echo "‚úÖ Extracted $extracted_files files"
        else
          echo "‚ùå Extraction appears incomplete"
          exit 1
        fi

  build-mail-module:
    needs: prepare-environment
    runs-on: windows-latest
    if: (needs.prepare-environment.outputs.skip-build != 'true' || github.event.inputs.force_rebuild == 'true') && needs.prepare-environment.result == 'success'
    
    outputs:
      build-success: ${{ steps.verify-build.outputs.success }}
      
    steps:
    - name: Checkout with submodules
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        submodules: recursive
        
    - name: Setup .NET and MSBuild
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: |
          6.0.x
          8.0.x
        
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2
      with:
        msbuild-architecture: x64
        
    - name: Setup NuGet
      uses: nuget/setup-nuget@v2
      with:
        nuget-version: 'latest'
        
    - name: Fix common project issues (RuntimeIdentifier and OutputPath)
      shell: pwsh
      run: |
        Write-Host "üîß Fixing common OnlyOffice project issues..."
        
        function Fix-ProjectFile {
          param($projectPath)
          
          if (-not (Test-Path $projectPath)) {
            Write-Host "‚ö†Ô∏è Project not found: $projectPath"
            return
          }
          
          Write-Host "Fixing project: $projectPath"
          $content = Get-Content $projectPath -Raw
          $modified = $false
          
          if ($content -match '<Project\s+Sdk=') {
            Write-Host "  SDK-style project detected"
            
            if ($content -notmatch '<RuntimeIdentifiers>') {
              if ($content -match '(<PropertyGroup[^>]*>)') {
                $replacement = "`$1`n    <RuntimeIdentifiers>win-x64;win-x86;win;any</RuntimeIdentifiers>"
                $content = $content -replace '(<PropertyGroup[^>]*>)', $replacement
                Write-Host "  ‚úÖ Added RuntimeIdentifiers"
                $modified = $true
              }
            }
            
            if ($content -notmatch '<OutputPath>' -and $content -notmatch '<BaseOutputPath>') {
              if ($content -match '(<PropertyGroup[^>]*>)') {
                $replacement = "`$1`n    <OutputPath>bin\`$(Configuration)\</OutputPath>`n    <BaseOutputPath>bin\</BaseOutputPath>"
                $content = $content -replace '(<PropertyGroup[^>]*>)', $replacement
                Write-Host "  ‚úÖ Added OutputPath and BaseOutputPath"
                $modified = $true
              }
            }
            
            if ($content -notmatch '<Platforms>' -and $content -notmatch '<Platform>') {
              if ($content -match '(<PropertyGroup[^>]*>)') {
                $replacement = "`$1`n    <Platforms>AnyCPU;x64;x86</Platforms>`n    <Platform Condition=`"'`$(Platform)' == ''`">AnyCPU</Platform>"
                $content = $content -replace '(<PropertyGroup[^>]*>)', $replacement
                Write-Host "  ‚úÖ Added Platform configuration"
                $modified = $true
              }
            }
            
          } else {
            Write-Host "  Legacy project format"
            
            if ($content -notmatch 'AnyCPU\|Release' -and $content -match '<PropertyGroup.*Release.*>') {
              $content = $content -replace '(<PropertyGroup[^>]*Condition[^>]*Release[^>]*>)', '$1`n    <OutputPath>bin\Release\</OutputPath>`n    <Platform>AnyCPU</Platform>'
              Write-Host "  ‚úÖ Added legacy project OutputPath"
              $modified = $true
            }
          }
          
          if ($modified) {
            Set-Content -Path $projectPath -Value $content -Encoding UTF8
            Write-Host "  üíæ Project file updated"
          } else {
            Write-Host "  ‚ÑπÔ∏è No changes needed"
          }
        }
        
        $problemProjects = @(
          "common/ASC.Common/ASC.Common.csproj",
          "module/ASC.Mail.Server/ASC.Mail.Server/ASC.Mail.Server.csproj",
          "module/ASC.Api/ASC.Api/ASC.Api.Core.csproj",
          "module/ASC.Api/ASC.Specific/ASC.Specific.csproj",
          "web/studio/ASC.Web.Studio/Products/Files/ASC.Web.Files.csproj",
          "web/studio/ASC.Web.Studio/Products/CRM/ASC.Web.CRM.csproj",
          "common/ASC.Core.Common/ASC.Core.Common.csproj"
        )
        
        foreach ($project in $problemProjects) {
          Fix-ProjectFile -projectPath $project
        }
        
        Write-Host "üîç Searching for additional projects that might need fixing..."
        
        $allProjects = Get-ChildItem -Path "." -Filter "*.csproj" -Recurse | Where-Object { $_.FullName -notlike "*\obj\*" -and $_.FullName -notlike "*\bin\*" }
        
        foreach ($project in $allProjects) {
          $relativePath = $project.FullName.Replace((Get-Location).Path, "").TrimStart('\', '/')
          if ($problemProjects -notcontains $relativePath) {
            $content = Get-Content $project.FullName -Raw -ErrorAction SilentlyContinue
            if ($content -and ($content -match '<Project\s+Sdk=' -and $content -notmatch '<RuntimeIdentifiers>')) {
              Write-Host "Found additional SDK project needing RuntimeIdentifiers: $relativePath"
              Fix-ProjectFile -projectPath $relativePath
            }
          }
        }
        
        Write-Host "‚úÖ Project fixing complete"
        
    - name: Find actual solution configurations (improved)
      shell: pwsh
      run: |
        Write-Host "üîç Analyzing Studio.sln for build configurations..."
        
        if (Test-Path "Studio.sln") {
          $content = Get-Content "Studio.sln" -Raw
          
          Write-Host "Solution file found, size: $($content.Length) characters"
          
          $configFound = $false
          $validConfigs = @()
          
          if ($content -match 'GlobalSection\(SolutionConfigurationPlatforms\)\s*=\s*preSolution(.*?)EndGlobalSection') {
            $configSection = $matches[1]
            Write-Host "Found SolutionConfigurationPlatforms section"
            $configFound = $true
            
            $lines = $configSection -split "`r?`n"
            foreach ($line in $lines) {
              $trimmedLine = $line.Trim()
              if ($trimmedLine -match '^([^=]+)\s*=\s*([^=]+)$') {
                $leftSide = $matches[1].Trim()
                if ($leftSide -and $leftSide -ne "" -and $leftSide -notlike "*GlobalSection*" -and $leftSide -notlike "*EndGlobalSection*") {
                  $validConfigs += $leftSide
                  Write-Host "‚úÖ Found config: '$leftSide'"
                }
              }
            }
          }
          
          if (-not $configFound -or $validConfigs.Count -eq 0) {
            Write-Host "Trying ProjectConfigurationPlatforms method..."
            if ($content -match 'GlobalSection\(ProjectConfigurationPlatforms\)\s*=\s*postSolution(.*?)EndGlobalSection') {
              $projectConfigSection = $matches[1]
              
              $configPattern = '\.([^|]+\|[^.]+)\.'
              $regexMatches = [regex]::Matches($projectConfigSection, $configPattern)
              
              $uniqueConfigs = @{}
              foreach ($match in $regexMatches) {
                $config = $match.Groups[1].Value
                if ($config -and -not $uniqueConfigs.ContainsKey($config)) {
                  $uniqueConfigs[$config] = $true
                  $validConfigs += $config
                  Write-Host "‚úÖ Extracted config: '$config'"
                }
              }
              $configFound = $true
            }
          }
          
          if (-not $configFound -or $validConfigs.Count -eq 0) {
            Write-Host "No configurations found in solution, using standard .NET configurations"
            $validConfigs = @(
              "Release|Any CPU",
              "Debug|Any CPU",
              "Release|x64",
              "Debug|x64",
              "Release|x86",
              "Debug|x86"
            )
          }
          
          $validConfigs | Out-File -FilePath "valid_configs.txt" -Encoding UTF8
          
          $priorityConfigs = @()
          $priorityConfigs += $validConfigs | Where-Object { $_ -like "Release*Any CPU*" }
          $priorityConfigs += $validConfigs | Where-Object { $_ -like "Release*" -and $_ -notlike "*Any CPU*" }
          $priorityConfigs += $validConfigs | Where-Object { $_ -like "Debug*Any CPU*" }
          $priorityConfigs += $validConfigs | Where-Object { $_ -like "Debug*" -and $_ -notlike "*Any CPU*" }
          
          $finalConfigs = @()
          foreach ($config in $priorityConfigs) {
            if ($finalConfigs -notcontains $config) {
              $finalConfigs += $config
            }
          }
          
          foreach ($config in $validConfigs) {
            if ($finalConfigs -notcontains $config) {
              $finalConfigs += $config
            }
          }
          
          $finalConfigs | Out-File -FilePath "priority_configs.txt" -Encoding UTF8
          
          Write-Host "üíæ Saved $($finalConfigs.Count) configurations in priority order:"
          $finalConfigs | ForEach-Object { Write-Host "  $_" }
          
        } else {
          Write-Host "‚ùå Studio.sln not found - looking for alternative solution files"
          
          $solutionFiles = Get-ChildItem -Path "." -Filter "*.sln" -Recurse | Where-Object { $_.Name -notlike "*packages*" }
          
          if ($solutionFiles) {
            Write-Host "Found alternative solution files:"
            $solutionFiles | ForEach-Object { Write-Host "  $($_.FullName)" }
            
            $altSolution = $solutionFiles[0].FullName
            Write-Host "Using: $altSolution"
            
            Copy-Item $altSolution "Studio.sln"
            
            @("Release|Any CPU", "Debug|Any CPU") | Out-File -FilePath "valid_configs.txt" -Encoding UTF8
            @("Release|Any CPU", "Debug|Any CPU") | Out-File -FilePath "priority_configs.txt" -Encoding UTF8
          } else {
            Write-Host "‚ö†Ô∏è No solution files found - will try individual project builds"
            @("Release|Any CPU") | Out-File -FilePath "valid_configs.txt" -Encoding UTF8
            @("Release|Any CPU") | Out-File -FilePath "priority_configs.txt" -Encoding UTF8
          }
        }
        
    - name: NuGet restore with fixed projects
      shell: pwsh
      run: |
        Write-Host "üì¶ NuGet restore after fixing RuntimeIdentifiers..."
        
        if (Test-Path "Studio.sln") {
          Write-Host "Running nuget restore..."
          nuget restore Studio.sln -Verbosity normal -NonInteractive
          
          if ($LASTEXITCODE -ne 0) {
            Write-Host "Standard NuGet restore failed, trying dotnet restore..."
            dotnet restore Studio.sln --verbosity normal
          }
        }
        
    - name: Try building with discovered configurations (improved)
      shell: pwsh
      run: |
        Write-Host "üèóÔ∏è Building with discovered configurations..."
        
        $buildSuccess = $false
        
        $configFile = if (Test-Path "priority_configs.txt") { "priority_configs.txt" } else { "valid_configs.txt" }
        
        if ((Test-Path "Studio.sln") -and (Test-Path $configFile)) {
          $validConfigs = Get-Content $configFile
          
          Write-Host "Trying configurations in priority order:"
          foreach ($config in $validConfigs) {
            Write-Host "üî® Attempting: '$config'"
            
            if ($config -match '^([^|]+)\|(.+)$') {
              $configuration = $matches[1].Trim()
              $platform = $matches[2].Trim()
              
              if ($platform -eq "Any CPU") { $platform = "AnyCPU" }
              
              Write-Host "  Configuration: '$configuration'"
              Write-Host "  Platform: '$platform'"
              
              try {
                $startTime = Get-Date
                
                $buildArgs = @(
                  "Studio.sln"
                  "/p:Configuration=$configuration"
                  "/p:Platform=$platform"
                  "/verbosity:normal"
                  "/maxcpucount"
                  "/p:TreatWarningsAsErrors=false"
                  "/p:WarningLevel=1"
                  "/p:RestorePackages=true"
                  "/p:UseSharedCompilation=false"
                  "/p:GenerateFullPaths=true"
                  "/p:ContinueOnError=false"
                )
                
                Write-Host "  Running: msbuild $($buildArgs -join ' ')"
                
                $output = & msbuild $buildArgs 2>&1
                $exitCode = $LASTEXITCODE
                
                $endTime = Get-Date
                $duration = $endTime - $startTime
                
                if ($exitCode -eq 0) {
                  Write-Host "‚úÖ BUILD SUCCESS with $configuration|$platform (took $($duration.TotalMinutes.ToString('F1')) minutes)"
                  $buildSuccess = $true
                  echo "SOLUTION_BUILD_SUCCESS=true" >> $env:GITHUB_ENV
                  echo "BUILD_CONFIG=$configuration" >> $env:GITHUB_ENV
                  echo "BUILD_PLATFORM=$platform" >> $env:GITHUB_ENV
                  break
                } else {
                  Write-Host "‚ùå Build failed with exit code: $exitCode (took $($duration.TotalSeconds.ToString('F1')) seconds)"
                  
                  $outputLines = $output -split "`n"
                  $errorLines = $outputLines | Where-Object { $_ -like "*error*" -or $_ -like "*failed*" } | Select-Object -Last 5
                  if ($errorLines) {
                    Write-Host "  Last errors:"
                    $errorLines | ForEach-Object { Write-Host "    $_" }
                  }
                }
              } catch {
                Write-Host "‚ùå Build exception: $($_.Exception.Message)"
              }
            } else {
              Write-Host "‚ö†Ô∏è Invalid config format: '$config'"
            }
          }
        } else {
          Write-Host "‚ö†Ô∏è Solution file or configuration file not found"
          if (-not (Test-Path "Studio.sln")) { Write-Host "  Missing: Studio.sln" }
          if (-not (Test-Path $configFile)) { Write-Host "  Missing: $configFile" }
        }
        
        if (-not $buildSuccess) {
          Write-Host "‚ö†Ô∏è All solution configurations failed, will try individual projects"
          echo "SOLUTION_BUILD_SUCCESS=false" >> $env:GITHUB_ENV
        }
        
    - name: Build just the mail module (if solution failed)
      if: env.SOLUTION_BUILD_SUCCESS != 'true'
      shell: pwsh
      run: |
        Write-Host "üéØ Building only the mail module..."
        
        $criticalDeps = @(
          "common/ASC.Common/ASC.Common.csproj",
          "common/ASC.Core.Common/ASC.Core.Common.csproj"
        )
        
        Write-Host "Building critical dependencies first..."
        foreach ($dep in $criticalDeps) {
          if (Test-Path $dep) {
            Write-Host "Building dependency: $dep"
            
            $depBuilt = $false
            
            try {
              Write-Host "  Trying dotnet build..."
              dotnet build $dep --configuration Release --verbosity normal
              if ($LASTEXITCODE -eq 0) {
                Write-Host "  ‚úÖ dotnet build succeeded"
                $depBuilt = $true
              }
            } catch {
              Write-Host "  ‚ùå dotnet build failed"
            }
            
            if (-not $depBuilt) {
              try {
                Write-Host "  Trying MSBuild..."
                msbuild $dep /p:Configuration=Release /p:Platform="Any CPU" /verbosity:minimal
                if ($LASTEXITCODE -eq 0) {
                  Write-Host "  ‚úÖ MSBuild succeeded"
                  $depBuilt = $true
                }
              } catch {
                Write-Host "  ‚ùå MSBuild failed"
              }
            }
            
            if (-not $depBuilt) {
              Write-Host "  ‚ö†Ô∏è Could not build $dep"
            }
          }
        }
        
        $mailProject = "module/ASC.Mail/ASC.Mail/ASC.Mail.csproj"
        if (Test-Path $mailProject) {
          Write-Host "`nBuilding mail module: $mailProject"
          
          $mailBuilt = $false
          
          try {
            Write-Host "Trying dotnet build for mail module..."
            dotnet build $mailProject --configuration Release --verbosity normal
            if ($LASTEXITCODE -eq 0) {
              Write-Host "‚úÖ Mail module built with dotnet build"
              $mailBuilt = $true
              echo "MAIL_BUILD_SUCCESS=true" >> $env:GITHUB_ENV
            }
          } catch {
            Write-Host "dotnet build failed for mail module"
          }
          
          if (-not $mailBuilt) {
            try {
              Write-Host "Trying MSBuild for mail module..."
              msbuild $mailProject /p:Configuration=Release /p:Platform="Any CPU" /verbosity:normal
              if ($LASTEXITCODE -eq 0) {
                Write-Host "‚úÖ Mail module built with MSBuild"
                $mailBuilt = $true
                echo "MAIL_BUILD_SUCCESS=true" >> $env:GITHUB_ENV
              }
            } catch {
              Write-Host "MSBuild also failed for mail module"
            }
          }
          
          if (-not $mailBuilt) {
            Write-Host "‚ùå Could not build mail module with any method"
            echo "MAIL_BUILD_SUCCESS=false" >> $env:GITHUB_ENV
          }
        } else {
          Write-Host "‚ùå Mail project not found at: $mailProject"
          echo "MAIL_BUILD_SUCCESS=false" >> $env:GITHUB_ENV
        }
        
    - name: Comprehensive assembly search
      id: verify-build
      shell: pwsh
      run: |
        Write-Host "üîç Comprehensive search for built assemblies..."
        $success = $false
        $foundDlls = @()
        
        Write-Host "Searching for ASC.Mail.dll files..."
        try {
          $mailDlls = Get-ChildItem -Path "." -Name "ASC.Mail.dll" -Recurse -ErrorAction SilentlyContinue
          
          foreach ($dll in $mailDlls) {
            $size = $dll.Length
            $relativePath = $dll.FullName.Replace((Get-Location).Path, "").TrimStart('\', '/')
            
            Write-Host "Found ASC.Mail.dll:"
            Write-Host "  üìç Path: $relativePath"
            Write-Host "  üìè Size: $size bytes"
            Write-Host "  üìÖ Modified: $($dll.LastWriteTime)"
            
            if ($size -gt 10000) {
              try {
                $fileInfo = [System.Diagnostics.FileVersionInfo]::GetVersionInfo($dll.FullName)
                Write-Host "  üìã Version: $($fileInfo.FileVersion)"
                Write-Host "  ‚úÖ Valid assembly"
                
                $foundDlls += @{
                  Path = $relativePath
                  Size = $size
                  FullPath = $dll.FullName
                }
                $success = $true
              } catch {
                if ($size -gt 50000) {
                  Write-Host "  ‚úÖ Large file, likely valid (version check failed)"
                  $foundDlls += @{
                    Path = $relativePath
                    Size = $size
                    FullPath = $dll.FullName
                  }
                  $success = $true
                } else {
                  Write-Host "  ‚ö†Ô∏è Cannot verify and size suspicious"
                }
              }
            } else {
              Write-Host "  ‚ùå Too small - likely stub file"
            }
          }
        } catch {
          Write-Host "Error searching for ASC.Mail.dll: $($_.Exception.Message)"
        }
        
        Write-Host "`nSearching for other mail-related assemblies..."
        try {
          $otherMailDlls = Get-ChildItem -Path "." -Name "*Mail*.dll" -Recurse -ErrorAction SilentlyContinue | 
            Where-Object { $_.Length -gt 1000 -and $_.Name -ne "ASC.Mail.dll" } | 
            Sort-Object Length -Descending
          
          if ($otherMailDlls) {
            Write-Host "Other mail-related DLLs:"
            foreach ($dll in $otherMailDlls) {
              $relativePath = $dll.FullName.Replace((Get-Location).Path, "").TrimStart('\', '/')
              Write-Host "  üìÑ $relativePath ($($dll.Length) bytes)"
            }
          } else {
            Write-Host "No other mail-related DLLs found"
          }
        } catch {
          Write-Host "Error searching for other mail DLLs: $($_.Exception.Message)"
        }
        
        Write-Host "`nLargest DLLs in bin directories:"
        try {
          $binDlls = Get-ChildItem -Path "." -Name "*.dll" -Recurse -ErrorAction SilentlyContinue | 
            Where-Object { $_.DirectoryName -like "*bin*" } | 
            Sort-Object Length -Descending | 
            Select-Object -First 20
            
          if ($binDlls) {
            foreach ($dll in $binDlls) {
              $relativePath = $dll.FullName.Replace((Get-Location).Path, "").TrimStart('\', '/')
              $sizeKB = [math]::Round($dll.Length / 1024, 1)
              Write-Host "  üìÑ $relativePath ($sizeKB KB)"
            }
          } else {
            Write-Host "No DLLs found in bin directories"
          }
        } catch {
          Write-Host "Error listing bin DLLs: $($_.Exception.Message)"
        }
        
        if ($env:SOLUTION_BUILD_SUCCESS -eq "true") {
          Write-Host "`nüéØ Solution build was successful ($env:BUILD_CONFIG|$env:BUILD_PLATFORM)"
        } elseif ($env:MAIL_BUILD_SUCCESS -eq "true") {
          Write-Host "`nüéØ Individual mail module build was successful"
        } else {
          Write-Host "`n‚ö†Ô∏è No successful builds detected"
        }
        
        if ($success -and $foundDlls.Count -gt 0) {
          $sortedDlls = $foundDlls | Sort-Object Size -Descending
          $primaryDll = $sortedDlls[0]
          
          Write-Host "`n‚úÖ BUILD VERIFICATION SUCCESSFUL!"
          Write-Host "Primary ASC.Mail.dll: $($primaryDll.Path)"
          Write-Host "Size: $($primaryDll.Size) bytes"
          
          echo "success=true" >> $env:GITHUB_OUTPUT
          echo "main_dll_path=$($primaryDll.Path)" >> $env:GITHUB_OUTPUT
          echo "main_dll_dir=$(Split-Path $($primaryDll.Path) -Parent)" >> $env:GITHUB_OUTPUT
        } else {
          Write-Host "`n‚ùå NO VALID ASC.MAIL.DLL FOUND"
          Write-Host "Build appears to have failed completely"
          echo "success=false" >> $env:GITHUB_OUTPUT
        }
        
    - name: Upload build artifacts (always for debugging)
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-debug-${{ github.run_number }}
        path: |
          **/bin/**/*.dll
          **/*Mail*.dll
          **/*Mail*.pdb
          valid_configs.txt
          common/ASC.Common/ASC.Common.csproj
        retention-days: 2
        
    - name: Upload successful mail module build
      if: steps.verify-build.outputs.success == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: mail-module-build
        path: |
          ${{ steps.verify-build.outputs.main_dll_dir }}/**/*Mail*
        retention-days: 1

  create-custom-package:
    needs: [prepare-environment, build-mail-module]
    runs-on: ubuntu-latest
    if: always() && (needs.prepare-environment.result == 'success' || needs.prepare-environment.result == 'skipped')
    
    steps:
    - name: Checkout code (for fallback)
      uses: actions/checkout@v4
      with:
        fetch-depth: 1
        
    - name: Check job dependencies
      run: |
        echo "=== JOB DEPENDENCY STATUS ==="
        echo "prepare-environment result: ${{ needs.prepare-environment.result }}"
        echo "build-mail-module result: ${{ needs.build-mail-module.result }}"
        echo "prepare-environment outputs:"
        echo "  cache-hit-deb: ${{ needs.prepare-environment.outputs.cache-hit-deb }}"
        echo "  cache-hit-extracted: ${{ needs.prepare-environment.outputs.cache-hit-extracted }}"
        echo "  skip-build: ${{ needs.prepare-environment.outputs.skip-build }}"
        
    - name: Try to restore cached package
      id: restore-cache
      uses: actions/cache/restore@v4
      with:
        path: |
          onlyoffice-communityserver.deb
          official-package/
        key: onlyoffice-extracted-v2-${{ env.ONLYOFFICE_VERSION }}-${{ hashFiles('onlyoffice-communityserver.deb') }}
        restore-keys: |
          onlyoffice-extracted-v2-${{ env.ONLYOFFICE_VERSION }}-
          onlyoffice-extracted-v2-
          
    - name: Download artifacts from preparation job (fallback)
      if: steps.restore-cache.outputs.cache-hit != 'true'
      uses: actions/download-artifact@v4
      continue-on-error: true
      with:
        name: extracted-onlyoffice-package
        
    - name: Verify package availability
      run: |
        echo "üîç Checking package availability..."
        
        if [ -d "official-package" ] && [ -f "onlyoffice-communityserver.deb" ]; then
          echo "‚úÖ Package available from cache/artifacts"
          echo "üì¶ DEB size: $(ls -lh onlyoffice-communityserver.deb | awk '{print $5}')"
          echo "üìÅ Extracted files: $(find official-package -type f | wc -l)"
        else
          echo "‚ùå Package not available, need to download and extract"
          
          echo "üö® Emergency package download..."
          
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends wget dpkg-dev apt-transport-https ca-certificates
          
          echo "üîß Adding OnlyOffice repository..."
          wget -qO - https://download.onlyoffice.com/GPG-KEY-ONLYOFFICE | sudo apt-key add -
          echo "deb https://download.onlyoffice.com/repo/debian squeeze main" | sudo tee /etc/apt/sources.list.d/onlyoffice.list
          
          sudo apt-get update -qq
          
          download_success=false
          
          echo "üì¶ Downloading OnlyOffice Community Server..."
          
          if apt-get download onlyoffice-communityserver 2>/dev/null; then
            deb_file=$(find . -name "onlyoffice-communityserver*.deb" -type f | head -1)
            if [ -n "$deb_file" ] && [ -s "$deb_file" ]; then
              if [ "$deb_file" != "./onlyoffice-communityserver.deb" ]; then
                mv "$deb_file" onlyoffice-communityserver.deb
              fi
              echo "‚úÖ Emergency download successful!"
              download_success=true
            fi
          fi
          
          if [ "$download_success" = false ]; then
            echo "üîÑ Trying alternative repository..."
            echo "deb https://download.onlyoffice.com/repo/debian/community stable main" | sudo tee /etc/apt/sources.list.d/onlyoffice-community.list
            sudo apt-get update -qq
            
            if apt-get download onlyoffice-communityserver 2>/dev/null; then
              deb_file=$(find . -name "onlyoffice-communityserver*.deb" -type f | head -1)
              if [ -n "$deb_file" ] && [ -s "$deb_file" ]; then
                if [ "$deb_file" != "./onlyoffice-communityserver.deb" ]; then
                  mv "$deb_file" onlyoffice-communityserver.deb
                fi
                echo "‚úÖ Alternative repository download successful!"
                download_success=true
              fi
            fi
          fi
          
          if [ "$download_success" = false ]; then
            echo "‚ùå Emergency download failed"
            exit 1
          fi
          
          echo "üì¶ Emergency extraction..."
          mkdir -p official-package
          dpkg-deb -x onlyoffice-communityserver.deb official-package/
          dpkg-deb -e onlyoffice-communityserver.deb official-package/DEBIAN/
          
          echo "‚úÖ Emergency package preparation complete"
        fi
        
    - name: Download build artifacts (conditional)
      if: needs.build-mail-module.outputs.build-success == 'true'
      uses: actions/download-artifact@v4
      continue-on-error: true
      with:
        name: mail-module-build
        path: build-output/
        
    - name: Fast package creation
      run: |
        echo "üöÄ Fast package creation..."
        
        if [ ! -d "official-package" ]; then
          echo "‚ùå official-package directory still not found!"
          echo "Available directories:"
          ls -la
          exit 1
        fi
        
        echo "üìã Copying package structure..."
        cp -r official-package custom-package
        
        echo "‚úÖ Package structure copied"
        echo "üìä Files in custom package: $(find custom-package -type f | wc -l)"
        
        if [ -d "build-output/" ]; then
          echo "üìã Searching for built mail assemblies..."
          
          mail_dlls=$(find build-output -name "ASC.Mail.dll" -type f 2>/dev/null || true)
          
          if [ -n "$mail_dlls" ]; then
            echo "‚úÖ Found compiled mail assemblies:"
            echo "$mail_dlls"
            
            main_dll=$(echo "$mail_dlls" | xargs ls -la | sort -k5 -nr | head -1 | awk '{print $NF}')
            echo "üìã Using primary DLL: $main_dll"
            
            package_dlls=$(find custom-package -name "ASC.Mail.dll" -type f 2>/dev/null || true)
            
            if [ -n "$package_dlls" ]; then
              echo "üîÑ Replacing mail assemblies in package:"
              while IFS= read -r dll_path; do
                if [ -f "$dll_path" ]; then
                  cp "$main_dll" "$dll_path"
                  echo "  ‚úÖ Updated: $dll_path"
                fi
              done <<< "$package_dlls"
              
              main_dll_dir=$(dirname "$main_dll")
              for ext in pdb xml exe.config; do
                if [ -f "${main_dll_dir}/ASC.Mail.$ext" ]; then
                  while IFS= read -r dll_path; do
                    base_path="${dll_path%.dll}.$ext"
                    base_dir=$(dirname "$dll_path")
                    if [ -f "$base_path" ] || [ -d "$base_dir" ]; then
                      cp "${main_dll_dir}/ASC.Mail.$ext" "$base_dir/" 2>/dev/null || true
                      echo "  ‚úÖ Updated: ASC.Mail.$ext in $base_dir"
                    fi
                  done <<< "$package_dlls"
                fi
              done
              
            else
              echo "‚ö†Ô∏è No ASC.Mail.dll files found in package to replace"
              mkdir -p custom-package/opt/onlyoffice/CommunityServer/bin/
              echo "$mail_dlls" | while read -r dll; do
                if [ -f "$dll" ]; then
                  cp "$dll" custom-package/opt/onlyoffice/CommunityServer/bin/
                  echo "  ‚úÖ Added: $(basename "$dll") to package"
                fi
              done
            fi
            
          else
            echo "‚ÑπÔ∏è No ASC.Mail.dll found in build output, using original mail module"
            echo "Available files in build-output:"
            find build-output -name "*.dll" -type f | head -10 || echo "No DLL files found"
          fi
        else
          echo "‚ÑπÔ∏è No build output available, using original mail module"
        fi
        
        if [ -d "custom-package/DEBIAN" ]; then
          echo "üîß Fixing DEBIAN script permissions..."
          
          for script in preinst postinst prerm postrm config templates; do
            if [ -f "custom-package/DEBIAN/$script" ]; then
              chmod 755 "custom-package/DEBIAN/$script"
              echo "‚úÖ Fixed $script: $(ls -la custom-package/DEBIAN/$script | awk '{print $1}')"
            fi
          done
          
          chmod 644 custom-package/DEBIAN/control 2>/dev/null || true
          chmod 644 custom-package/DEBIAN/conffiles 2>/dev/null || true
          chmod 644 custom-package/DEBIAN/md5sums 2>/dev/null || true
          
          echo "üìã Final DEBIAN permissions:"
          ls -la custom-package/DEBIAN/ | head -5
        fi
        
        if [ -f "custom-package/DEBIAN/control" ]; then
          sed -i "s/Package: onlyoffice-communityserver/Package: onlyoffice-communityserver-custom/" custom-package/DEBIAN/control
          sed -i "s/Version: \(.*\)/Version: \1-custom-${{ github.run_number }}/" custom-package/DEBIAN/control
        fi
        
        echo "üîç Validating package structure..."
        
        if [ ! -d "custom-package" ]; then
          echo "‚ùå Custom package directory not found!"
          exit 1
        fi
        
        if [ ! -d "custom-package/DEBIAN" ]; then
          echo "‚ùå DEBIAN directory not found!"
          exit 1
        fi
        
        if [ ! -f "custom-package/DEBIAN/control" ]; then
          echo "‚ùå Control file not found!"
          exit 1
        fi
        
        echo "‚úÖ Package structure validated"
        echo "üìä Total files: $(find custom-package -type f | wc -l)"
        echo "üì¶ Package size: $(du -sh custom-package | cut -f1)"
        
        echo "üî® Building DEB package..."
        
        sudo chown -R root:root custom-package/
        
        if dpkg-deb --build custom-package onlyoffice-communityserver-custom.deb 2>&1; then
          echo "‚úÖ Package built successfully!"
          
          if [ -f "onlyoffice-communityserver-custom.deb" ] && [ -s "onlyoffice-communityserver-custom.deb" ]; then
            echo "üì¶ Final package size: $(ls -lh onlyoffice-communityserver-custom.deb | awk '{print $5}')"
            
            echo "üîç Validating package integrity..."
            if dpkg-deb --info onlyoffice-communityserver-custom.deb >/dev/null 2>&1; then
              echo "‚úÖ Package validation passed!"
            else
              echo "‚ö†Ô∏è Package validation warnings (may still be usable)"
            fi
          else
            echo "‚ùå Package file is missing or empty"
            exit 1
          fi
        else
          echo "‚ùå Package build failed!"
          echo "üìã DEBIAN directory final state:"
          ls -la custom-package/DEBIAN/
          exit 1
        fi
        
    - name: Upload custom package
      uses: actions/upload-artifact@v4
      with:
        name: onlyoffice-custom-${{ github.run_number }}
        path: onlyoffice-communityserver-custom.deb
        retention-days: 7

  build-docker:
    needs: create-custom-package
    runs-on: ubuntu-latest
    if: needs.create-custom-package.result == 'success' && github.event.inputs.skip_docker != 'true'
    
    steps:
    - name: Download custom package
      uses: actions/download-artifact@v4
      with:
        name: onlyoffice-custom-${{ github.run_number }}
        
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Fast Docker build
      run: |
        cat > Dockerfile << 'EOF'
        FROM ubuntu:20.04
        ENV DEBIAN_FRONTEND=noninteractive
        
        RUN apt-get update && apt-get install -y --no-install-recommends \
            wget curl supervisor nginx && \
            rm -rf /var/lib/apt/lists/*
            
        COPY onlyoffice-communityserver-custom.deb /tmp/
        RUN dpkg -i /tmp/onlyoffice-communityserver-custom.deb || apt-get install -f -y && \
            rm /tmp/onlyoffice-communityserver-custom.deb
        
        LABEL version="${{ env.ONLYOFFICE_VERSION }}-custom-${{ github.run_number }}"
        EXPOSE 80 443
        CMD ["/usr/bin/supervisord", "-c", "/etc/supervisor/supervisord.conf"]
        EOF
        
        DOCKER_BUILDKIT=1 docker build --progress=plain -t onlyoffice-custom-mail:latest .
        
        docker save onlyoffice-custom-mail:latest | gzip -1 > onlyoffice-custom-mail-image.tar.gz
        
        echo "üì¶ Image size: $(ls -lh onlyoffice-custom-mail-image.tar.gz | awk '{print $5}')"
        
    - name: Upload Docker image
      uses: actions/upload-artifact@v4
      with:
        name: onlyoffice-docker-${{ github.run_number }}
        path: onlyoffice-custom-mail-image.tar.gz
        retention-days: 3
